# Auto-generated by Cimas: Do not edit it manually!
# See https://github.com/metanorma/cimas
name: ubuntu

on:
  push:
    branches: [ master ]
    tags:
      - '*'

jobs:
  rsync:
    name: rsync
    runs-on: ubuntu-latest
    # continue-on-error: ${{ matrix.experimental }}
    steps:
      - uses: actions/checkout@master
      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.BOOST_CVS_SSH_PRIVATE_KEY }}
          name: id_rsa # optional
          known_hosts: ${{ secrets.BOOST_CONSEIL_KNOWN_HOSTS }}
          config: |
            Host cvs.boost-lab.net
              User ronald
              IdentityFile ~/.ssh/id_rsa
      - name: Test SSH
        run: |
          ssh ronald@cvs.boost-lab.net 'ls ../'
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install cvs-fast-export

      - name: Setup Git
        run: |
          git config --global user.name "metanorma-ci"
          git config --global user.email "metanorma-ci@users.noreply.github.com"

      - name: Initialize new git repository at iso-10303-stepmod-cvs
        run: |
          git init iso-10303-stepmod-cvs
          git -C iso-10303-stepmod-cvs remote add origin \
            https://metanorma-ci:${{ secrets.METANORMA_CI_PAT_TOKEN }}@github.com/metanorma/iso-10303-stepmod-cvs

      # - name: rsync to stepmod-rsync/
      #   run: |
      #     rsync -avrPz -e ssh ronald@cvs.boost-lab.net:/stepmod/ stepmod/
      - name: Run cvssync to sync to 'stepmod-rsync'
        run: |
          mkdir stepmod
          cvssync -v ronald@cvs.boost-lab.net:/stepmod stepmod/data

      # - name: Create fast-import file for Git
      #   run: |
      #     cvsconvert -v -p -A author-map.txt stepmod/data
      - name: Create fast-import file for Git
        run: |
          find stepmod/data | cvs-fast-export -t 4 -p -A author-map.txt > stepmod.fi

      - name: Import fast-import file
        run: |
          git -C iso-10303-stepmod-cvs fast-import < stepmod.fi

      - name: Copy out stepmod/repository_index.xml
        env:
          CVSROOT: ronald@cvs.boost-lab.net:/stepmod
          CVS_RSH: ssh
        run: |
          cd /tmp
          cvs co stepmod/repository_index.xml
          cd $GITHUB_WORKSPACE/iso-10303-stepmod-cvs
          mv /tmp/stepmod/repository_index.xml .
          git add repository_index.xml
          git commit -m 'Add repository_index.xml'
      - name: Git log
        run: |
          cd $GITHUB_WORKSPACE/iso-10303-stepmod-cvs
          git log | head -100
      - name: Git push to iso-10303-stepmod-cvs
        run: |
          cd $GITHUB_WORKSPACE/iso-10303-stepmod-cvs
          git push -f

