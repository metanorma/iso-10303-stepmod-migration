# Auto-generated by Cimas: Do not edit it manually!
# See https://github.com/metanorma/cimas
name: import

on:
  push:
    branches: [ main ]
    # tags:
    #   - '*'
  schedule:
    - cron: '0 1 * * *'  # every day at 1:00

jobs:
  import:
    name: import
    runs-on: ubuntu-latest
    # continue-on-error: ${{ matrix.experimental }}
    steps:
      - uses: actions/checkout@v2
      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.BOOST_CVS_SSH_PRIVATE_KEY }}
          name: id_rsa # optional
          known_hosts: ${{ secrets.BOOST_CONSEIL_KNOWN_HOSTS }}
          config: |
            Host cvs.boost-lab.net
              User ronald
              IdentityFile ~/.ssh/id_rsa
      - name: Test SSH
        run: |
          ssh ronald@cvs.boost-lab.net 'ls ../'
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install cvs-fast-export

      - name: Setup Git
        run: |
          git config --global user.name "metanorma-ci"
          git config --global user.email "metanorma-ci@users.noreply.github.com"

      - name: Initialize new git repository at iso-10303-stepmod-cvs
        run: |
          git init iso-10303-stepmod-cvs

      - name: Add GitHub remote to git repo
        run: |
          git -C iso-10303-stepmod-cvs remote add origin \
            https://${{ secrets.METANORMA_CI_USERNAME }}:${{ secrets.METANORMA_CI_PAT_TOKEN }}@github.com/metanorma/iso-10303-stepmod-cvs

      - name: Add ISO BitBucket remote to git repo
        run: |
          git -C iso-10303-stepmod-cvs remote add iso \
            https://${{ secrets.ISO_BITBUCKET_USERNAME_URLENCODED }}:${{ secrets.ISO_BITBUCKET_PAT_TOKEN_URLENCODED }}@sd.iso.org/bitbucket-pilot/scm/~ronald.tse_eccma.org/smrl-metanorma.git

      # - name: rsync to stepmod-rsync/
      #   run: |
      #     rsync -avrPz -e ssh ronald@cvs.boost-lab.net:/stepmod/ stepmod/
      - name: Run cvssync to sync to 'stepmod-rsync'
        run: |
          mkdir stepmod
          cvssync -v ronald@cvs.boost-lab.net:/stepmod stepmod/data

      # - name: Create fast-import file for Git
      #   run: |
      #     ## cvsconvert doesn't seem to be working in the latest version
      #     cvsconvert -v -p -A author-map.txt stepmod/data
      - name: Create fast-import file for Git
        run: |
          find stepmod/data | cvs-fast-export -t 4 -p -A author-map.txt > stepmod.fi

      - name: Import fast-import file
        run: |
          git -C iso-10303-stepmod-cvs fast-import < stepmod.fi

      - name: Git reset newly imported repo and rename master to main
        run: |
          git -C iso-10303-stepmod-cvs reset --hard
          git -C iso-10303-stepmod-cvs branch -m master main

      - name: Remove large files from history that have been already deleted
        run: |
          curl -sSL https://repo1.maven.org/maven2/com/madgag/bfg/1.14.0/bfg-1.14.0.jar -o bfg.jar
          java -jar bfg.jar --strip-blobs-bigger-than 100M iso-10303-stepmod-cvs
          git -C iso-10303-stepmod-cvs reflog expire --expire=now --all && \
            git -C iso-10303-stepmod-cvs gc --prune=now --aggressive

      - name: Copy out stepmod/repository_index.xml
        env:
          CVSROOT: ronald@cvs.boost-lab.net:/stepmod
          CVS_RSH: ssh
        run: |
          pushd /tmp
          cvs co stepmod/repository_index.xml
          popd
          cd iso-10303-stepmod-cvs
          mv /tmp/stepmod/repository_index.xml .
          git add repository_index.xml
          git commit -m 'Add repository_index.xml'

      - name: Git log
        run: |
          git -C iso-10303-stepmod-cvs log | head -100

      - name: Git push to GitHub iso-10303-stepmod-cvs
        run: |
          git -C iso-10303-stepmod-cvs push --all -f
          git -C iso-10303-stepmod-cvs push --tags -f

      - name: Git push to ISO iso-10303-stepmod-cvs
        run: |
          git -C iso-10303-stepmod-cvs push --all -f iso
          git -C iso-10303-stepmod-cvs push --tags -f iso
